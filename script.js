const baseIllustrations = [
    { src: './01.png', description: 'Esboço a lápis com linhas feitas à mão simulando grafite.', price: 87 },
    { src: './02.png', description: ' Ilustração com contornos limpos, expressivos e bem definidos.', price: 87 },
    { src: './03.png', description: 'Ilustração digital colorida com textura manual imitando pinceladas.', price: 87 },
    { src: './04.png', description: 'Ilustração estilo 3D mais infantil e acabamento limpo.', price: 87 },
    { src: './05.png', description: 'Ilustração voltada para infantojuvenil mais realista.', price: 87 },
    { src: './06.png', description: 'Ilustração aquarelada para estilo mais delicado.', price: 87 },
    { src: './07.png', description: 'Ilustração com contorno deixando mais atraente.', price: 87 },
    { src: './08.png', description: 'ustração estilo vetorial limpo e mais sólido.', price: 87 },
];

const additionalModalImagesForFirstIllustration = [
    { src: './01A.png', description: 'A professora repreende o menino Juca.' },
    { src: './01B.png', description: 'O menino Juca estava voando entre as nuvens' },
    { src: './01C.png', description: 'O cão e o gato assistiam o pôr do sol.' },
    { src: './01D.png', description: 'Juca ensinava sobre a internet para a lagartinha.' },
    { src: './01E.png', description: 'A abelhinha era muito produtiva.' },
    { src: './01F.png', description: 'A fazendeira gostava muito de sua fazenda. ' },
    { src: './01G.png', description: 'O cachoro skatista muito engraçado.' },
];

const additionalModalImagesForSecondIllustration = [
  { src: './02A.png', description: 'O menino sonhava ser um astronauta.' },
  { src: './02B.png', description: 'Diversão e brincadeira em família.' },
  { src: './02C.png', description: 'O fazendeiro passeava com o seu burrinho.' },
  { src: './02D.png', description: 'O gatinho sapeca fugia do cão feroz.' },
  { src: './02E.png', description: 'O menino descia muito rápido de bicicleta.' },
  
];

const additionalModalImagesForThirdIllustration = [
  { src: './03A.png', description: 'O menino brincava com o seu cãozinho.' },
  { src: './03B.png', description: 'O menino correu daquele touro feroz.' },
  { src: './03C.png', description: 'Ele abraçou sua mãezinha feliz.' },
  { src: './03D.png', description: 'Isso que chamo de manobra radical.' },
  { src: './03E.png', description: 'Ele não tinha dinheiro para comprar picolé.' },
  { src: './03F.png', description: 'O cachorrinho dormia o dia todo' },
  { src: './03G.png', description: 'Ele cantava dirigindo seu caminhão.' },
  { src: './03H.png', description: 'Essa era a dança do pinguim feliz.' },
  { src: './03I.png', description: 'Você conhece a história desse gato?.' },
  { src: './03J.png', description: 'Ele se escondia nas latas de lixo.' },
  { src: './03L.png', description: 'O espertalhão sabia como convencer.' },
  { src: './03M.png', description: 'O gatinho passeava pelo campo.' },
  { src: './03N.png', description: 'Lucas gostava de sentir o vento.' },
  { src: './03O.png', description: 'Nesse dia ele viu algo no céu.' },
  { src: './03P.png', description: 'O sol te aquecia todos os dias' },
  { src: './03Q.png', description: 'O seu pai é um super herói?' },
];

const additionalModalImagesForFourthIllustration = [
  { src: './04A.png', description: 'Menina empinando pipa com o seu cãozinho.' },
  { src: './04B.png', description: 'O menino conversava com o sirizinho.' },
  { src: './04C.png', description: 'Ela abraçava seu gatinho chato.' },
  { src: './04D.png', description: 'O feirante vendia muito naquele dia.' },
  { src: './04E.png', description: 'Ele corria em volta da fazendinha.' },
  { src: './04F.png', description: 'Eles estavam com medo de cair da bike.' },
  { src: './04G.png', description: 'Ele se vestia de super-herói e fazia o bem.' },
  { src: './04H.png', description: 'Eles passavam o dia juntos lendo livro.' },
 
];
const additionalModalImagesForFifthIllustration = [
  { src: './05A.png', description: 'Jovem andava de skate pelas vias perigozamente.' },
  { src: './05B.png', description: 'O carteiro foi atacado pelos cães.' },
  { src: './05C.png', description: 'Ele pedia esmolas para sobreviver.' },
  { src: './05D.png', description: 'O dinossauro atacou o seu carro.' },
  { src: './05E.png', description: 'Ele ia todas manhãs pescar no lago.' },
  { src: './05F.png', description: 'Ela chorava sempre que se lembrava disso.' },
  { src: './05G.png', description: 'Os zumbis o atacaram em bando.' },
  { src: './05H.png', description: 'Joãozinho foi visto pelo gigante.' },
  { src: './05I.png', description: 'Tudo parecia enorme diante dele.' },
  { src: './05J.png', description: 'Ele tinha asas e podia voar.' },  
 
];

const additionalModalImagesForSixthIllustration = [
  { src: './06A.png', description: 'O cozinheiro dava um show na cozinha.' },
  { src: './06B.png', description: 'O menino arqueiro estava treinando.' },
  { src: './06C.png', description: 'Ele brincava com a sua tartaruguinha.' },
  { src: './06D.png', description: 'Era noite de lua cheia.' },
  { src: './06E.png', description: 'Juca tinha muita imaginação.' },
  { src: './06F.png', description: 'Ela comprou um sorvete.' },
  { src: './06G.png', description: 'O urso regava as plantas todo dia.' },
 
];
const additionalModalImagesForSeventhIllustration = [
  { src: './07A.png', description: 'Jesus afastava o perigo salvando sua ovelha.' },
  { src: './07B.png', description: 'O menino se divertia com o seu papai.' },
  { src: './07C.png', description: 'Ele finalmente chegou ao topo.' },
  { src: './07D.png', description: 'Ela se despedia de seu filho.' },
  { src: './07E.png', description: 'Juca gostava de trepar em árvores.' },
  { src: './07F.png', description: 'O rei se assustou com o dragão.' },
  { src: './07G.png', description: 'Eles gostavam de caminhar pela rua.' },
  { src: './07H.png', description: 'Joãozinho ficava sempre no celular' },
  { src: './07I.png', description: 'O pescador conversava com a baleia' },
  { src: './07J.png', description: 'O gnomo da riqueza se distraia' }, 
  { src: './07L.png', description: 'O Jacaré que gostava de dançar' }, 
 
];
const additionalModalImagesForEighthIllustration = [
  { src: './08A.png', description: 'Ela percebeu que estava sendo seguida.' },
  { src: './08B.png', description: 'O pirata alegre e que gostava de dançar.' },
  { src: './08C.png', description: 'A princesa beijou o dapo gosmento.' },
  { src: './08D.png', description: 'A rainha da selva em ação.' },
  { src: './08E.png', description: 'O leão demonstrando bravura.' },
  { src: './08F.png', description: 'Ele tentava conquistá-la sempre.' },
  { src: './08G.png', description: 'O barão queria pagar a sua conta.' },
  { src: './08H.png', description: 'A sua fantasia ficou linda.' },
  { src: './08I.png', description: 'Esse bebê gostava de livros.' },
  { src: './08J.png', description: 'E jesus apareceu sobre as águas.' }, 
  { src: './08L.png', description: 'Ela gostava de cozinhar o dia todo.' }, 
 
];




const gallery = document.getElementById('gallery');
const modal = document.getElementById('modal');
const modalImage = document.getElementById('modal-image');
const modalDescription = document.getElementById('modal-description');
const closeButton = document.querySelector('.close-button');
const prevButton = document.getElementById('prev-button');
const nextButton = document.getElementById('next-button');

const quantitySlider = document.getElementById('quantity-slider');
const currentQuantitySpan = document.getElementById('current-quantity');
const totalPriceSpan = document.getElementById('total-price');

const optionTextLayout = document.getElementById('option-text-layout');
const optionCoverDesign = document.getElementById('option-cover-design');
const optionBookTrailer = document.getElementById('option-book-trailer');

const optionCashDiscount = document.getElementById('option-cash-discount');
const optionFiftyFifty = document.getElementById('option-fifty-fifty');

const generateQrcodeButton = document.getElementById('generate-qrcode-button');
const qrModal = document.getElementById('qr-modal');
const qrModalClose = document.querySelector('.qr-close-button');
const qrcodeDiv = document.getElementById('qrcode');
const qrModalMessage = document.getElementById('qr-modal-message');
const downloadDetailsButton = document.getElementById('download-details-button');
const copyPixKeyButton = document.getElementById('copy-pix-key-button');

// New elements for How It Works Modal
const howItWorksButton = document.getElementById('how-it-works-button');
const howItWorksModal = document.getElementById('how-it-works-modal');
const howItWorksCloseButton = document.querySelector('.how-it-works-close-button');
const howItWorksContent = document.getElementById('how-it-works-content'); 

const TEXT_LAYOUT_PRICE_PER_ILLUSTRATION = 180;
const COVER_DESIGN_PRICE = 250;
const BOOK_TRAILER_PRICE = 280;

const DISPLAY_QUANTITY = 8;

let currentModalIndex = 0;
let currentModalImages = [];


// Define content for service info popups
const serviceInfoContent = {
    'text-layout': {
        title: 'Sobre Texto e Diagramação',
        description: 'Este serviço inclui a organização e formatação do texto (quando fornecido) e a sua correta integração com as ilustrações dentro de um layout específico, garantindo que texto e imagem se complementem de forma harmoniosa na página.'
    },
    'cover-design': {
        title: 'Sobre Ilustração de Design de Capa',
        description: 'Uma ilustração de capa é uma peça visual única e impactante, criada especificamente para o design frontal de um livro, e-book ou material promocional. Seu objetivo principal é atrair o leitor e transmitir a essência da obra, podendo ter um estilo ou complexidade diferente das ilustrações internas.'
    },
    'book-trailer': {
        title: 'Sobre Criação de Book Trailer',
        description: 'A criação de um book trailer envolve a produção de um pequeno vídeo promocional para o seu livro. Inclui a seleção ou criação de artes (estáticas ou animadas), edição de vídeo, adição de música e, se necessário, locução ou efeitos sonoros para gerar interesse e expectativa.',
        videoUrl: 'https://www.youtube.com/embed/dQw4w9WgXcQ?rel=0'
    }
};





// --- Provided Pix generation script ---
// Updated with user's information
const chavePix = "estudioanimattos@gmail.com";
const nomeRecebedor = "Alessandro Mattos";
const cidadeRecebedor = "Rio de Janeiro";

function calculateCRC16(str) {
  let crc = 0xFFFF;
  let polynomial = 0x1021;

  for (let i = 0; i < str.length; i++) {
    let byte = str.charCodeAt(i) & 0xFF;
    crc ^= byte << 8;
    for (let j = 0; j < 8; j++) {
      if ((crc & 0x8000) !== 0) {
        crc = ((crc << 1) ^ polynomial) & 0xFFFF;
      } else {
        crc = (crc << 1) & 0xFFFF;
      }
    }
  }

  crc &= 0xFFFF;
  const hex = crc.toString(16).toUpperCase().padStart(4, '0');
  return hex;
}

// Helper function to format TLV (Tag, Length, Value)
const formatTLV = (tag, value) => {
    const len = value.length;
    const lenStr = len.toString().padStart(2, '0');
    return `${tag}${lenStr}${value}`;
};

function generatePixData(valor, selectedDetails) {
  const valorFormatado = valor.toFixed(2);
  // Include selected details in the description/transaction ID if possible,
  // but the EMV standard has limitations on custom fields and length.
  // For simplicity and standard compliance, we'll keep a simple ID
  // and display details in the modal text, not the QR payload itself.
  // The EMV standard doesn't have dedicated fields for detailed order breakdowns.
  const idTx = "***"; 

  // Payload format indicator (ID 00) - Must be '01'
  const payloadFormatIndicator = formatTLV('00', '01');

  // Point of Initiation Method (ID 01) - '11' for static QR, '12' for dynamic
   const pointOfInitiation = formatTLV('01', '11');


  // Merchant account information (ID 26)
  let merchantAccount = formatTLV('00', 'BR.GOV.BCB.PIX'); 
  merchantAccount += formatTLV('01', chavePix); 
  // Optional: GUI (00), Key type (01), Description (02), URL (25)
  // We could add a brief description here, but length is limited.
  // Let's stick to the required fields for maximum compatibility.
  const merchantAccountInformation = formatTLV('26', merchantAccount);


  // Merchant category code (ID 52) - Using 0000 for no MCC provided
  const merchantCategoryCode = formatTLV('52', '0000');

  // Transaction currency (ID 53) - 986 for BRL
  const transactionCurrency = formatTLV('53', '986');

  // Transaction amount (ID 54)
  const transactionAmount = formatTLV('54', valorFormatado);

  // Country code (ID 58) - BR for Brazil
  const countryCode = formatTLV('58', 'BR');

  // Merchant name (ID 59)
  const merchantName = formatTLV('59', nomeRecebedor);

  // Merchant city (ID 60)
  const merchantCity = formatTLV('60', cidadeRecebedor);

  // Additional Data Field Template (ID 62)
  // Field 05: Reference Label (Transaction ID)
  let additionalData = formatTLV('05', idTx); 
  const additionalDataFieldTemplate = formatTLV('62', additionalData);


  // Concatenate the components *before* the CRC tag
  let pixCodeDataWithoutCRC = payloadFormatIndicator + pointOfInitiation + merchantAccountInformation + merchantCategoryCode + transactionCurrency + transactionAmount + countryCode + merchantName + merchantCity + additionalDataFieldTemplate;

  // CRC16-CCITT tag (ID 63) - This must be the LAST field's tag, *before* calculating the CRC
  let crc16Tag = "6304"; 

  // Calculate CRC on the payload string *including* the '6304' tag
  const payloadForCRC = pixCodeDataWithoutCRC + crc16Tag;
  const calculatedCrc16 = calculateCRC16(payloadForCRC);

  // Append the CRC tag and the calculated CRC value
  const pixCode = payloadForCRC + calculatedCrc16;

  return pixCode;
}


// --- TROCAR AQUI PRA BAIXO ---



// --- End of provided Pix generation script ---


function createGalleryItem(illustration, index) {
    const itemDiv = document.createElement('div');
    itemDiv.classList.add('gallery-item');
    itemDiv.dataset.index = index;

    const imageContainer = document.createElement('div');
    imageContainer.classList.add('image-container');

    const img = document.createElement('img');
    img.src = illustration.src;
    img.alt = 'Thumbnail: ' + illustration.description;

    imageContainer.appendChild(img);

    const infoRow = document.createElement('div');
    infoRow.classList.add('info-row');

    const priceDisplay = document.createElement('div');
    priceDisplay.classList.add('illustration-price');
    priceDisplay.textContent = `R$ ${illustration.price.toFixed(2)}`;

    const checkboxContainer = document.createElement('div');
    checkboxContainer.classList.add('illustration-checkbox');
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = `illustration-${index}`;
    checkbox.checked = false; 
    const label = document.createElement('label');
    label.htmlFor = `illustration-${index}`;
    label.textContent = `Incluir (${index + 1})`; 

    checkboxContainer.appendChild(checkbox);
    checkboxContainer.appendChild(label);

    infoRow.appendChild(priceDisplay);
    infoRow.appendChild(checkboxContainer);

    itemDiv.appendChild(imageContainer);
    itemDiv.appendChild(infoRow);

    itemDiv.addEventListener('click', (event) => {
         if (!checkboxContainer.contains(event.target)) {
             openModal(index);
        }
    });


    checkbox.addEventListener('change', function() {
        handleCheckboxChange(this);
        updateCalculationDisplay();
    });

    // Allows clicking the entire checkbox container or label to toggle
    checkboxContainer.addEventListener('click', (event) => {
         if (event.target !== checkbox) {
             checkbox.checked = !checkbox.checked;
             handleCheckboxChange(checkbox);
             updateCalculationDisplay();
         }
    });


    return itemDiv;
}

function handleCheckboxChange(changedCheckbox) {
    const checkboxes = gallery.querySelectorAll('.illustration-checkbox input[type="checkbox"]');

    if (changedCheckbox.checked) {
        checkboxes.forEach(checkbox => {
            if (checkbox !== changedCheckbox) {
                checkbox.checked = false;
                checkbox.disabled = true;
                checkbox.closest('.gallery-item').classList.add('disabled');
            }
        });
    } else {
        checkboxes.forEach(checkbox => {
            checkbox.disabled = false;
            checkbox.closest('.gallery-item').classList.remove('disabled');
        });
    }
}

function populateGallery() {
    gallery.innerHTML = '';

    const illustrationsToDisplay = baseIllustrations.slice(0, Math.min(DISPLAY_QUANTITY, baseIllustrations.length));

    illustrationsToDisplay.forEach((illustration, index) => {
        const item = createGalleryItem(illustration, index);
        gallery.appendChild(item);
    });

}

function updateCalculationDisplay() {
    const quantity = parseInt(quantitySlider.value, 10);
    currentQuantitySpan.textContent = quantity;

    let selectedIllustrationsBaseCost = 0;
    let selectedIllustrationIndex = -1;

    const selectedCheckbox = gallery.querySelector('.illustration-checkbox input[type="checkbox"]:checked');

    if (selectedCheckbox) {
        const itemDiv = selectedCheckbox.closest('.gallery-item');
        const index = parseInt(itemDiv.dataset.index, 10);
        if (index >= 0 && index < baseIllustrations.length) {
            selectedIllustrationsBaseCost = baseIllustrations[index].price;
            selectedIllustrationIndex = index; 
        } else {
            console.warn("Selected illustration index out of bounds:", index);
            selectedCheckbox.checked = false;
            handleCheckboxChange(selectedCheckbox); 
        }
    }

    let baseTotal = selectedIllustrationsBaseCost * quantity;

    let additionalServicesList = [];
    if (optionTextLayout.checked) {
        baseTotal += quantity * TEXT_LAYOUT_PRICE_PER_ILLUSTRATION;
        additionalServicesList.push('Texto e diagramação');
    }
    if (optionCoverDesign.checked) {
        baseTotal += COVER_DESIGN_PRICE;
        additionalServicesList.push('Ilustração de design de capa');
    }
    if (optionBookTrailer.checked) {
        baseTotal += BOOK_TRAILER_PRICE;
        additionalServicesList.push('Criação de book trailer');
    }

    let finalPrice = baseTotal;

    const cashDiscountOptionDiv = optionCashDiscount.closest('.payment-option');
    const fiftyFiftyOptionDiv = optionFiftyFifty.closest('.payment-option');

    document.querySelectorAll('.payment-option').forEach(div => div.classList.remove('selected'));

    // Handle exclusive payment options
    if (optionCashDiscount.checked && optionFiftyFifty.checked) {
        // If both are checked, uncheck the one most recently checked, or fiftyFifty
        // Let's enforce cash discount if both are attempted.
        optionFiftyFifty.checked = false;
    } else if (!optionCashDiscount.checked && !optionFiftyFifty.checked) {
         // Default state, no specific class
    }


    if (optionCashDiscount.checked) {
        finalPrice = baseTotal * 0.9;
        cashDiscountOptionDiv.classList.add('selected');
    } else if (optionFiftyFifty.checked) {
        finalPrice = baseTotal * 0.5;
        fiftyFiftyOptionDiv.classList.add('selected');
    } else {
        finalPrice = baseTotal; // No discount or split
    }

     totalPriceSpan.textContent = `R$ ${finalPrice.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

     // Return details for QR modal message
     return {
         selectedIllustrationIndex: selectedIllustrationIndex,
         quantity: quantity,
         additionalServices: additionalServicesList,
         finalPrice: finalPrice,
         paymentOption: optionCashDiscount.checked ? 'À Vista (10% desconto)' : (optionFiftyFifty.checked ? '50% agora, 50% na entrega' : 'Preço Cheio')
     };
}

function updateModalContent(newIndex) {
    if (currentModalImages.length === 0) {
        console.error("No images available for modal.");
        closeModal();
        return;
    }

    const effectiveIndex = (newIndex % currentModalImages.length + currentModalImages.length) % currentModalImages.length;

    const imageItem = currentModalImages[effectiveIndex];

    if (!imageItem || !imageItem.src) {
        console.error("Invalid image item at index", effectiveIndex, imageItem);
        closeModal();
        return;
    }

    modalImage.src = imageItem.src;

    let descriptionText = 'Descrição não disponível.';
    // Prioritize description directly on the modal item, then fall back to base illustration description
    if (imageItem.description) {
        descriptionText = imageItem.description;
    } else if (imageItem.baseIndex !== undefined && baseIllustrations[imageItem.baseIndex]) {
        descriptionText = baseIllustrations[imageItem.baseIndex].description;
    }

    modalDescription.textContent = descriptionText;

    currentModalIndex = effectiveIndex;
}

function openModal(baseIndex) {
    const baseIllustration = baseIllustrations[baseIndex];

    if (!baseIllustration) {
        console.error("Base illustration not found for index:", baseIndex);
        return;
    }

    currentModalImages = [];

    
    
    
    // --- TROCAR AQUI PRA CIMA ---
    
    
    
    
    // Always include the base illustration as the first item
    currentModalImages.push({ src: baseIllustration.src, baseIndex: baseIndex, description: baseIllustration.description });

    // Add specific additional images if needed (currently only for index 0)
    if (baseIndex === 0) {
    currentModalImages.push(...additionalModalImagesForFirstIllustration);
} else if (baseIndex === 1) {
    currentModalImages.push(...additionalModalImagesForSecondIllustration);
} else if (baseIndex === 2) {
    currentModalImages.push(...additionalModalImagesForThirdIllustration);
} else if (baseIndex === 3) {
    currentModalImages.push(...additionalModalImagesForFourthIllustration);  
} else if (baseIndex === 4) {
    currentModalImages.push(...additionalModalImagesForFifthIllustration); 

} else if (baseIndex === 5) {
    currentModalImages.push(...additionalModalImagesForSixthIllustration); 

} else if (baseIndex === 6) {
    currentModalImages.push(...additionalModalImagesForSeventhIllustration); 

} else if (baseIndex === 7) {
    currentModalImages.push(...additionalModalImagesForEighthIllustration); 

}
  

    currentModalIndex = 0; 
    updateModalContent(0);

    modal.classList.add('active');
}

function closeModal() {
    modal.classList.remove('active');
    currentModalImages = [];
    currentModalIndex = 0;
    modalImage.src = "";
    modalDescription.textContent = "";
}

function closeQrModal() {
    qrModal.classList.remove('active');
    // Clear the QR code when modal is closed
    if (qrcodeDiv) {
        qrcodeDiv.innerHTML = '';
    }
    // Reset copy button text
    if (copyPixKeyButton) {
        copyPixKeyButton.textContent = 'Copiar Chave Pix';
        copyPixKeyButton.classList.remove('copied'); // Remove success state class
    }
}

// New function to close the "How It Works" modal
function closeHowItWorksModal() {
    howItWorksModal.classList.remove('active');
}


prevButton.addEventListener('click', () => {
    updateModalContent(currentModalIndex - 1);
});

nextButton.addEventListener('click', () => {
    updateModalContent(currentModalIndex + 1);
});

// Use the existing close button for the main modal
closeButton.addEventListener('click', closeModal);

// Use the new close button for the QR modal
qrModalClose.addEventListener('click', closeQrModal);

// Add event listener for the new "How It Works" button
howItWorksButton.addEventListener('click', () => {
    howItWorksModal.classList.add('active');
});

// Add event listener for the new "How It Works" close button
howItWorksCloseButton.addEventListener('click', closeHowItWorksModal);


// Close modals if clicking outside the content
window.addEventListener('click', (event) => {
    if (event.target === modal) {
        closeModal();
    }
    if (event.target === qrModal) {
        closeQrModal();
    }
     if (event.target === howItWorksModal) {
        closeHowItWorksModal();
    }
});


quantitySlider.addEventListener('input', updateCalculationDisplay);

optionTextLayout.addEventListener('change', updateCalculationDisplay);
optionCoverDesign.addEventListener('change', updateCalculationDisplay);
optionBookTrailer.addEventListener('change', updateCalculationDisplay);

// Ensure only one payment option can be selected
optionCashDiscount.addEventListener('change', function() {
    if (this.checked) {
        optionFiftyFifty.checked = false; 
    }
    updateCalculationDisplay();
});
optionFiftyFifty.addEventListener('change', function() {
    if (this.checked) {
        optionCashDiscount.checked = false; 
    }
    updateCalculationDisplay();
});

generateQrcodeButton.addEventListener('click', () => {
    const calculationDetails = updateCalculationDisplay(); 

    const totalAmount = calculationDetails.finalPrice;
    const selectedIllustrationIndex = calculationDetails.selectedIllustrationIndex;
    const quantity = calculationDetails.quantity;
    const additionalServices = calculationDetails.additionalServices;
    const paymentOption = calculationDetails.paymentOption;


    if (selectedIllustrationIndex === -1 || quantity <= 0) {
         alert("Por favor, selecione uma ilustração e a quantidade desejada.");
         return;
    }

    if (isNaN(totalAmount) || totalAmount <= 0) {
        alert("Por favor, selecione uma ilustração e quantidade para calcular o valor total.");
        return;
    }

    // Generate Pix payload - EMV standard doesn't include detailed order breakdown
    // The details will be shown in the modal message instead.
    // Passing selectedDetails just in case generatePixData ever needs them (it doesn't for payload)
    const pixPayload = generatePixData(totalAmount, calculationDetails);

    console.log("Generated Pix Payload:", pixPayload);

    if (qrcodeDiv) {
        qrcodeDiv.innerHTML = ''; 
    } else {
        console.error("QR code div not found.");
        alert("Erro interno: Elemento QR Code não encontrado.");
        return;
    }

    try {
        if (typeof QRCode !== 'undefined') {
            new QRCode(qrcodeDiv, {
                text: pixPayload,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            // Format the order details for the modal message
            let orderDetailsHtml = `
                <h3>Resumo do Pedido:</h3>
                <p><strong>Ilustração Selecionada:</strong> #${selectedIllustrationIndex + 1}</p>
                <p><strong>Quantidade:</strong> ${quantity}</p>
            `;

            if (additionalServices.length > 0) {
                orderDetailsHtml += `<p><strong>Serviços Adicionais:</strong> ${additionalServices.join(', ')}</p>`;
            } else {
                 orderDetailsHtml += `<p><strong>Serviços Adicionais:</strong> Nenhum</p>`;
            }

            orderDetailsHtml += `
                <p><strong>Forma de Pagamento:</strong> ${paymentOption}</p>
                <p><strong>Valor:</strong> R$ ${totalAmount.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
                <hr style="margin: 15px 0;">
                <p>Escaneie o QR Code acima para pagar via Pix.</p>
                <p style="font-size: 0.8em; color: #777;">
                    <strong>Nome:</strong> ${nomeRecebedor}<br>
                    <strong>Chave Pix:</strong> ${chavePix} <br>
                    <strong>Cidade:</strong> ${cidadeRecebedor}
                </p>
            `;

            // Update the QR modal message with order details and payment instructions
            qrModalMessage.innerHTML = orderDetailsHtml; 


            qrModal.classList.add('active');

        } else {
            console.error("QRCode library not loaded.");
            alert("Erro ao carregar a biblioteca de QR Code.");
        }
    } catch (error) {
        console.error("Error generating QR Code:", error);
        alert("Erro ao gerar o QR Code.");
    }
});

// Add event listener for the download button
downloadDetailsButton.addEventListener('click', () => {
    // Get the text content from the qr-modal-message div
    const detailsText = qrModalMessage.innerText || qrModalMessage.textContent;

    // Clean up extra whitespace from the message for better download
    const cleanedText = detailsText.split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0)
        .join('\n');


    // Create a Blob with the text content
    const blob = new Blob([cleanedText], { type: 'text/plain' });

    // Create a download link
    const downloadLink = document.createElement('a');
    downloadLink.href = URL.createObjectURL(blob);
    downloadLink.download = 'detalhes_pedido_ilustracao.txt';

    // Programmatically click the link to trigger the download
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);

    // Revoke the object URL to free up resources
    URL.revokeObjectURL(downloadLink.href);
});

// Add event listener for the Copy Pix Key button
copyPixKeyButton.addEventListener('click', () => {
    navigator.clipboard.writeText(chavePix).then(() => {
        // Optional: Provide user feedback
        copyPixKeyButton.textContent = 'Copiado!';
        copyPixKeyButton.classList.add('copied'); // Add a success state class

        // Reset button text after a short delay
        setTimeout(() => {
            copyPixKeyButton.textContent = 'Copiar Chave Pix';
            copyPixKeyButton.classList.remove('copied'); // Remove success state class
        }, 2000); // Reset after 2 seconds
    }).catch(err => {
        console.error('Failed to copy text: ', err);
        alert('Erro ao copiar a chave Pix.');
    });
});


// Initial population and calculation display
populateGallery();
updateCalculationDisplay();
